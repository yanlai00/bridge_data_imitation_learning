Bootstrap: docker
From: nvidia/cuda:10.1-cudnn7-devel-ubuntu16.04
%post
    PACKAGES=/packages
    mkdir $PACKAGES
    mkdir -p /global/scratch/btrabucco
    mkdir -p /global/home/users/btrabucco
    #Add nvidia driver paths to the environment variables
    echo "\n #Nvidia driver paths \n" >> /environment
    echo 'export PATH="/nvbin:$PATH"' >> /environment
    echo 'export LD_LIBRARY_PATH="/nvlib:$LD_LIBRARY_PATH"' >> /environment
    #Add CUDA paths
    echo "\n #Cuda paths \n" >> /environment
    echo 'export CPATH="/usr/local/cuda/include:$CPATH"' >> /environment
    echo 'export PATH="/usr/local/cuda/bin:$PATH"' >> /environment
    echo 'export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"' >> /environment
    echo 'export CUDA_HOME="/usr/local/cuda"' >> /environment
    touch /bin/nvidia-smi
    touch /usr/bin/nvidia-smi
    touch /usr/bin/nvidia-debugdump
    touch /usr/bin/nvidia-persistenced
    touch /usr/bin/nvidia-cuda-mps-control
    touch /usr/bin/nvidia-cuda-mps-server
    mkdir /etc/dcv
    mkdir /var/lib/dcv-gl
    mkdir /usr/lib64
    mkdir /root/.ssh
    echo "YOUR SSH PRIVATE KEY HERE" > /root/.ssh/id_rsa
    echo "YOUR SSH PUBLIC KEY HERE" > /root/.ssh/id_rsa.pub
    chmod 700 /root/.ssh
    chmod 600 /root/.ssh/id_rsa
    chmod 644 /root/.ssh/id_rsa.pub
    apt-get update -y
    apt-get install -y wget
    apt-get install -y unzip
    apt-get install -y git
    apt-get install -y htop
    apt-get install -y libosmesa-dev libglew-dev patchelf libglfw3-dev build-essential
    apt-get install -y libglib2.0-0 libsm6 libxext6 libxrender-dev
    apt-get install -y cmake libopenmpi-dev python3-dev zlib1g-dev
    conda create -n spt python=3.7 -y
    conda activate spt
    chmod -R 777 $PACKAGES
